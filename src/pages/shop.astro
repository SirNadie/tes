---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import ProductCard from "../components/ProductCard.astro";
import { getProducts } from "../data/products";

const allProducts = await getProducts();

// Get unique categories from products
const uniqueCategories = [
    ...new Set(allProducts.map((p) => p.category)),
].sort();
const categories = ["All", ...uniqueCategories];

// Get search params
const categoryParam = Astro.url.searchParams.get("category");
const priceParam = Astro.url.searchParams.get("price");

// Filter products
let products = allProducts;

if (categoryParam && categoryParam !== "All") {
    products = products.filter(
        (p) => p.category.toLowerCase() === categoryParam.toLowerCase(),
    );
}

if (priceParam) {
    const priceRanges = priceParam.split(",");
    products = products.filter((p) => {
        const price = Number(p.price);
        return priceRanges.some((range) => {
            if (range === "under-25") return price < 25;
            if (range === "25-50") return price >= 25 && price <= 50;
            if (range === "50-100") return price >= 50 && price <= 100;
            if (range === "over-100") return price > 100;
            return false;
        });
    });
}

const priceRanges = [
    { label: "Under $25", value: "under-25" },
    { label: "$25 - $50", value: "25-50" },
    { label: "$50 - $100", value: "50-100" },
    { label: "Over $100", value: "over-100" },
];
---

<Layout title="Shop | The Everyday Shop">
    <div
        class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden"
    >
        <Header />
        <main class="flex-1">
            <div class="mx-auto max-w-7xl px-8 py-12">
                <div class="flex flex-col md:flex-row gap-12">
                    <!-- Sidebar -->
                    <aside class="w-full md:w-64 flex-shrink-0">
                        <div class="sticky top-24">
                            <h3 class="font-display text-xl font-semibold mb-6">
                                Filters
                            </h3>

                            <div class="mb-8">
                                <h4
                                    class="font-medium mb-3 text-sm uppercase tracking-wider text-gray-500"
                                >
                                    Categories
                                </h4>
                                <ul class="space-y-2">
                                    {
                                        categories.map((category) => (
                                            <li>
                                                <a
                                                    href={`/shop?category=${encodeURIComponent(category)}${priceParam ? `&price=${priceParam}` : ""}`}
                                                    class:list={[
                                                        "text-gray-600 hover:text-primary transition-colors block py-1",
                                                        {
                                                            "font-semibold text-primary":
                                                                category ===
                                                                    categoryParam ||
                                                                (category ===
                                                                    "All" &&
                                                                    !categoryParam),
                                                        },
                                                    ]}
                                                >
                                                    {category}
                                                </a>
                                            </li>
                                        ))
                                    }
                                </ul>
                            </div>

                            <div class="mb-8">
                                <h4
                                    class="font-medium mb-3 text-sm uppercase tracking-wider text-gray-500"
                                >
                                    Price Range
                                </h4>
                                <div class="space-y-2">
                                    {
                                        priceRanges.map((range) => (
                                            <label class="flex items-center gap-2 text-gray-600 cursor-pointer hover:text-primary transition-colors">
                                                <input
                                                    type="checkbox"
                                                    value={range.value}
                                                    checked={priceParam
                                                        ?.split(",")
                                                        .includes(range.value)}
                                                    class="price-filter rounded border-gray-300 text-primary focus:ring-primary"
                                                />
                                                {range.label}
                                            </label>
                                        ))
                                    }
                                </div>
                            </div>

                            {
                                (categoryParam || priceParam) && (
                                    <a
                                        href="/shop"
                                        class="text-sm text-red-500 hover:text-red-700 underline decoration-red-500/30 hover:decoration-red-700/50 underline-offset-4 transition-all"
                                    >
                                        Clear all filters
                                    </a>
                                )
                            }
                        </div>
                    </aside>

                    <!-- Product Grid -->
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-8">
                            <h1 class="font-display text-3xl font-semibold">
                                {
                                    categoryParam && categoryParam !== "All"
                                        ? categoryParam
                                        : "All Products"
                                }
                                <span
                                    class="ml-3 inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10"
                                >
                                    {products.length}
                                    {products.length === 1 ? "item" : "items"}
                                </span>
                            </h1>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500"
                                    >Sort by:</span
                                >
                                <select
                                    class="text-sm border-none bg-transparent font-medium text-gray-900 focus:ring-0 cursor-pointer"
                                >
                                    <option>Featured</option>
                                    <option>Newest</option>
                                    <option>Price: Low to High</option>
                                    <option>Price: High to Low</option>
                                </select>
                            </div>
                        </div>

                        {
                            products.length > 0 ? (
                                <div class="grid grid-cols-1 gap-x-6 gap-y-12 sm:grid-cols-2 lg:grid-cols-3">
                                    {products.map((product) => (
                                        <ProductCard
                                            id={product.id}
                                            title={product.title}
                                            price={product.price}
                                            image={product.image}
                                            category={product.category}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div class="text-center py-20 bg-gray-50 rounded-lg">
                                    <span class="material-symbols-outlined text-4xl text-gray-400 mb-4">
                                        search_off
                                    </span>
                                    <p class="text-gray-500 text-lg">
                                        No products found matching your filters.
                                    </p>
                                    <a
                                        href="/shop"
                                        class="text-primary font-medium hover:underline mt-2 inline-block"
                                    >
                                        Clear filters
                                    </a>
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>
        </main>
        <Footer />
    </div>
</Layout>

<script>
    document.addEventListener("change", (e) => {
        const target = e.target;
        if (
            target &&
            target instanceof HTMLInputElement &&
            target.classList.contains("price-filter")
        ) {
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);

            const checkedValues = Array.from(
                document.querySelectorAll(".price-filter"),
            )
                .filter((cb) => (cb as HTMLInputElement).checked)
                .map((cb) => (cb as HTMLInputElement).value);

            if (checkedValues.length > 0) {
                params.set("price", checkedValues.join(","));
            } else {
                params.delete("price");
            }

            // Keep category if exists
            const category = params.get("category");
            if (category) {
                params.set("category", category);
            }

            window.location.href = `${window.location.pathname}?${params.toString()}`;
        }
    });
</script>
